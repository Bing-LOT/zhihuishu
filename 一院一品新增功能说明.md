# 一院一品新增功能对接说明

## 完成内容

### 1. API 接口完善

**文件**: `src/api/college.ts`

**新增类型定义** `AddCollegeParams`：
```typescript
{
  coverUrl: string      // 封面图片（必需）
  name: string          // 课程名称（必需）
  college: string       // 所在学院（必需）
  teachers: string[]    // 主讲教师，多个（必需）
  types: string[]       // 建设课程类型，多个（必需）
  content: string       // 课程详情内容（必需）
  showFront: number     // 前台显示：1=显示；0=隐藏（必需）
}
```

**接口函数**: `addCollege(data: AddCollegeParams)`

### 2. 页面功能实现

**文件**: `src/views/admin/Resources/CollegeSpecial.vue`

#### 2.1 新增功能流程

1. **表单验证**
   - ✅ 验证所有必填项（课程名称、封面图片、教师姓名、所属单位、课程分类、详细内容）
   - ✅ 提供友好的错误提示

2. **封面图片处理**
   - ✅ 自动检测图片类型（base64 或 URL）
   - ✅ 如果是 base64，自动转换为 File 对象并上传到服务器
   - ✅ 获取上传后的真实 URL

3. **数据格式转换**
   - ✅ 教师姓名：从字符串（用顿号分隔）转为数组
   - ✅ 课程分类：从单选值转为数组
   - ✅ 显示状态：从布尔值转为数字（1 或 0）

4. **API 调用**
   - ✅ 调用 `/college/add` 接口
   - ✅ 传递符合接口规范的参数

5. **结果处理**
   - ✅ 成功：提示用户、关闭对话框、刷新列表
   - ✅ 失败：显示错误信息
   - ✅ 加载状态：显示 loading，防止重复提交

#### 2.2 富文本编辑器图片上传

**已集成真实上传接口**：
- ✅ 在富文本编辑器中插入图片时，自动调用 `uploadFile` 接口
- ✅ 上传成功后，将真实 URL 插入编辑器
- ✅ 上传失败时，显示错误提示

### 3. 核心代码

#### 3.1 保存逻辑（部分）

```typescript
// 处理封面图片：如果是 base64，需要先上传
let coverUrl = formData.value.coverUrl
if (coverUrl.startsWith('data:image/')) {
  const blob = await fetch(coverUrl).then(r => r.blob())
  const file = new File([blob], 'cover.jpg', { type: blob.type })
  const uploadResult = await uploadFile(file)
  coverUrl = uploadResult.url
}

// 将字符串转换为数组
const teachersArray = formData.value.teachers.split('、').filter(t => t.trim())
const typesArray = [formData.value.types]

// 调用新增API
await addCollege({
  name: formData.value.name,
  coverUrl: coverUrl,
  teachers: teachersArray,
  college: formData.value.college,
  types: typesArray,
  content: formData.value.content,
  showFront: formData.value.showOnFrontend ? 1 : 0
})
```

#### 3.2 富文本图片上传

```typescript
uploadImage: {
  maxFileSize: 5 * 1024 * 1024, // 5M
  maxNumberOfFiles: 10,
  async customUpload(file: File, insertFn: any) {
    const result = await uploadFile(file)
    insertFn(result.url, '', result.url)
  }
}
```

## 使用说明

### 新增一院一品

1. **点击「新增」按钮**
   - 打开新增对话框

2. **填写表单**
   - 课程名称：输入课程名称
   - 封面图片：点击上传（支持选择本地图片）
   - 教师姓名：输入教师姓名，多个教师用顿号（、）分隔
   - 所属单位：从下拉框选择学院
   - 课程分类：从下拉框选择分类
   - 课程详细内容：使用富文本编辑器编辑（支持图片、表格等）
   - 前台显示：勾选表示显示，不勾选表示隐藏

3. **保存**
   - 点击「保存」按钮
   - 系统自动验证表单
   - 如有 base64 图片，自动上传获取 URL
   - 调用 API 新增数据
   - 成功后自动刷新列表

### 教师字段说明

**输入格式**：
- 单个教师：`张三`
- 多个教师：`张三、李四、王五`

**转换逻辑**：
- 系统自动按顿号（、）分割
- 转换为数组：`["张三", "李四", "王五"]`
- 传给后端 API

### 课程分类说明

**选择方式**：单选下拉框

**可选项**：
- 通识教育课程
- 学科基础课程
- 专业必修课程
- 专业选修课程
- 跨学科或本硕博课程
- 双创实践与素质拓展课程
- 集中性实践课程

**转换逻辑**：
- 单选值转换为数组传给后端
- 例如选择「专业必修课程」→ `["专业必修课程"]`

## 注意事项

1. **图片上传**
   - 封面图片大小建议不超过 5MB
   - 富文本编辑器中的图片也会自动上传到服务器
   - 支持的图片格式：jpg、jpeg、png、gif、webp

2. **必填验证**
   - 所有标有红色星号（*）的字段都是必填的
   - 提交前会进行完整性检查

3. **加载状态**
   - 保存过程中会显示 loading 状态
   - 防止用户重复提交

4. **错误处理**
   - 如果上传失败，会显示具体的错误信息
   - 请检查网络连接或联系管理员

## 测试步骤

1. ✅ 点击「新增」按钮，打开对话框
2. ✅ 填写所有必填项
3. ✅ 上传封面图片
4. ✅ 在富文本编辑器中插入图片测试
5. ✅ 点击「保存」按钮
6. ✅ 验证是否成功创建并刷新列表
7. ✅ 检查后台数据是否正确

## 技术细节

### 请求示例

```javascript
POST /college/add

{
  "coverUrl": "https://example.com/uploads/image.jpg",
  "name": "新时代中国特色社会主义思想融入专业课程实践",
  "college": "计算机与大数据学院",
  "teachers": ["张教授", "李教授"],
  "types": ["专业必修课程"],
  "content": "<p>课程详细内容...</p>",
  "showFront": 1
}
```

### 响应示例

```javascript
{
  "code": 200,
  "msg": "操作成功",
  "data": null
}
```

## 后续扩展

**编辑功能**：
- 目前编辑功能已预留接口位置
- 需要后端提供 `/college/update` 接口
- 实现逻辑与新增类似

**删除功能**：
- 已预留删除按钮和接口
- 需要后端提供 `/college/delete` 接口

## 相关文件

- `src/api/college.ts` - API 接口定义
- `src/api/banner.ts` - 文件上传接口
- `src/views/admin/Resources/CollegeSpecial.vue` - 页面组件

