# 一院一品编辑功能对接说明

## 完成内容

### 1. API 接口定义

**文件**: `src/api/college.ts`

#### 新增类型定义 `EditCollegeParams`

```typescript
export interface EditCollegeParams {
  id: number           // 业务id（必需）
  coverUrl: string     // 封面图片（必需）
  name: string         // 课程名称（必需）
  college: string      // 所在学院（必需）
  teachers: string[]   // 主讲教师，多个（必需）
  types: string[]      // 建设课程类型，多个（必需）
  content: string      // 课程详情内容（必需）
  showFront: number    // 前台显示：1=显示；0=隐藏（必需）
}
```

#### 接口函数

```typescript
export function updateCollege(data: EditCollegeParams) {
  return request.put('/college/edit', data)
}
```

**关键信息**：
- 接口路径：`/college/edit`
- 请求方式：`PUT`
- 参数类型：`EditCollegeParams`

### 2. 页面功能实现

**文件**: `src/views/admin/Resources/CollegeSpecial.vue`

#### 2.1 编辑功能流程

1. **点击编辑按钮**
   - ✅ 从列表项获取数据
   - ✅ 填充到表单中
   - ✅ 打开编辑对话框

2. **数据填充逻辑**
   ```typescript
   const editItem = (item: CollegeItem) => {
     formData.value = {
       id: item.id.toString(),
       name: item.name,
       coverUrl: item.coverUrl || '',
       teachers: item.teachers.join('、'),  // 数组转字符串
       college: item.college,
       types: item.types[0] || '',          // 取第一个元素
       content: item.content,
       showOnFrontend: item.showFront === 1
     }
     showEditDialog.value = true
   }
   ```

3. **表单验证**
   - ✅ 验证所有必填项
   - ✅ 提供友好的错误提示

4. **图片处理**
   - ✅ 如果用户重新上传了封面（base64），自动上传获取新 URL
   - ✅ 如果未改动封面，使用原有 URL

5. **数据格式转换**
   - ✅ 教师：字符串（顿号分隔）→ 数组
   - ✅ 分类：单选值 → 数组
   - ✅ 显示状态：布尔值 → 数字（0/1）
   - ✅ ID：字符串 → 数字

6. **API 调用**
   ```typescript
   await updateCollege({
     id: Number(formData.value.id),
     name: formData.value.name,
     coverUrl: coverUrl,
     teachers: teachersArray,
     college: formData.value.college,
     types: typesArray,
     content: formData.value.content,
     showFront: formData.value.showOnFrontend ? 1 : 0
   })
   ```

7. **结果处理**
   - ✅ 成功：提示「编辑成功！」、关闭对话框、刷新列表
   - ✅ 失败：显示错误信息
   - ✅ 加载状态：显示 loading，防止重复提交

#### 2.2 对话框关闭优化

```typescript
const closeDialog = () => {
  showAddDialog.value = false
  showEditDialog.value = false
  
  // 重置表单数据
  formData.value = { /* ... */ }
  
  // 清空富文本编辑器内容
  if (editorRef.value) {
    editorRef.value.clear()
  }
}
```

**优化点**：
- ✅ 关闭对话框时清空富文本编辑器
- ✅ 防止下次打开时显示旧内容

## 使用说明

### 编辑一院一品

1. **点击编辑按钮**
   - 在列表中找到要编辑的记录
   - 点击「编辑」按钮（铅笔图标）

2. **修改表单内容**
   - 表单会自动填充当前数据
   - 可以修改任何字段：
     - 课程名称
     - 封面图片（可重新上传）
     - 教师姓名（多个教师用顿号分隔）
     - 所属单位（下拉选择）
     - 课程分类（下拉选择）
     - 课程详细内容（富文本编辑器）
     - 前台显示（复选框）

3. **保存修改**
   - 点击「保存」按钮
   - 系统自动验证表单
   - 如果重新上传了封面，自动上传获取 URL
   - 调用 API 更新数据
   - 成功后自动刷新列表

### 字段说明

#### ID 字段
- 在编辑时自动传递
- 用户无需关心
- 系统自动将字符串转为数字类型

#### 封面图片
- **未改动**：使用原有 URL
- **重新上传**：检测到 base64，自动上传获取新 URL

#### 教师字段
- **显示**：数组转字符串，用顿号连接
  - 例如：`["张三", "李四"]` → `"张三、李四"`
- **保存**：字符串转数组
  - 例如：`"张三、李四"` → `["张三", "李四"]`

#### 课程分类
- **显示**：从数组中取第一个元素
  - 例如：`["专业必修课程"]` → `"专业必修课程"`
- **保存**：单选值转为数组
  - 例如：`"专业必修课程"` → `["专业必修课程"]`

## API 请求示例

### 请求格式

```http
PUT /college/edit
Content-Type: application/json

{
  "id": 123,
  "coverUrl": "https://example.com/image.jpg",
  "name": "课程名称",
  "college": "计算机与大数据学院",
  "teachers": ["张教授", "李教授"],
  "types": ["专业必修课程"],
  "content": "<p>富文本内容</p>",
  "showFront": 1
}
```

### 响应格式

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": null
}
```

## 与新增功能的对比

| 功能 | 新增 | 编辑 |
|------|------|------|
| 接口路径 | `/college/add` | `/college/edit` |
| 请求方式 | POST | PUT |
| ID 参数 | ❌ 不需要 | ✅ 必需 |
| 数据来源 | 空表单 | 从列表项填充 |
| 图片处理 | 必须上传 | 可选上传（未改动则用原 URL）|
| 成功提示 | "新增成功！" | "编辑成功！" |

## 技术细节

### 1. 请求方法选择

编辑接口使用 `PUT` 方法，符合 RESTful API 规范：
- POST：创建资源
- PUT：更新资源
- DELETE：删除资源

### 2. 图片处理逻辑

```typescript
let coverUrl = formData.value.coverUrl

// 检测是否为 base64（说明用户重新上传了图片）
if (coverUrl.startsWith('data:image/')) {
  const blob = await fetch(coverUrl).then(r => r.blob())
  const file = new File([blob], 'cover.jpg', { type: blob.type })
  const uploadResult = await uploadFile(file)
  coverUrl = uploadResult.url  // 使用新 URL
}
// 否则使用原有 URL
```

### 3. 富文本编辑器处理

编辑时：
```typescript
// 富文本编辑器通过 v-model 自动绑定 formData.content
// 会自动显示 HTML 内容
```

关闭时：
```typescript
// 清空编辑器，防止下次打开显示旧内容
editorRef.value.clear()
```

### 4. 数据转换映射

**前端表单 → API 参数**：
```typescript
{
  id: string              → id: number
  teachers: string        → teachers: string[]
  types: string          → types: string[]
  showOnFrontend: boolean → showFront: number
}
```

**API 返回 → 前端表单**：
```typescript
{
  id: number              → id: string
  teachers: string[]      → teachers: string
  types: string[]        → types: string
  showFront: number      → showOnFrontend: boolean
}
```

## 测试步骤

1. ✅ 在列表中找到一条记录
2. ✅ 点击「编辑」按钮
3. ✅ 验证表单是否正确填充了数据
4. ✅ 修改部分字段
5. ✅ 测试重新上传封面图片
6. ✅ 测试修改富文本内容
7. ✅ 点击「保存」按钮
8. ✅ 验证是否显示「编辑成功！」提示
9. ✅ 验证列表是否自动刷新
10. ✅ 验证修改后的数据是否正确

## 注意事项

1. **ID 必须传递**
   - 编辑时必须包含 `id` 字段
   - 系统会自动从原数据中获取

2. **所有字段都是必填**
   - 即使某个字段未修改，也必须传递原值
   - 接口设计要求所有字段都必填

3. **图片 URL 处理**
   - 如果未重新上传，传递原 URL
   - 如果重新上传，先调用上传接口获取新 URL

4. **富文本内容**
   - 编辑器会保存 HTML 格式的内容
   - 提交时直接传递 HTML 字符串

5. **加载状态管理**
   - 保存过程中禁用按钮
   - 防止用户重复提交

## 错误处理

常见错误及解决方案：

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 400 Bad Request | 参数缺失或格式错误 | 检查所有必填字段 |
| 404 Not Found | ID 不存在 | 检查记录是否已被删除 |
| 413 Payload Too Large | 图片太大 | 压缩图片或限制上传大小 |
| 500 Internal Server Error | 服务器错误 | 联系后端开发人员 |

## 相关文件

- `src/api/college.ts` - API 接口定义
- `src/api/banner.ts` - 文件上传接口  
- `src/views/admin/Resources/CollegeSpecial.vue` - 页面组件
- `一院一品新增功能说明.md` - 新增功能文档

## 完成状态

- ✅ API 接口定义
- ✅ 页面编辑功能实现
- ✅ 图片上传处理
- ✅ 数据格式转换
- ✅ 表单验证
- ✅ 成功提示和列表刷新
- ✅ 富文本编辑器清空
- ✅ 错误处理
- ✅ 加载状态管理

